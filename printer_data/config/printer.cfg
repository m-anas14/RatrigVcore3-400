#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 600
variable_macro_travel_accel: 8000


[ratos]
allow_unsupported_slicer_versions: True
#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: x_dir_pin      # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40   # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 400
position_endstop: 0

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: y_dir_pin      # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40   # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 400
position_endstop: 400

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin    # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4    # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 400

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin    # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4    # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin    # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4    # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: e_dir_pin     # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 5.6    
#pressure_advance: 0.05 # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300
max_temp: 360


[tmc2209 extruder]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC6
run_current: 0.8
sense_resistor: 0.11


[heater_bed]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
max_power: 0.8
max_temp: 150

# BLTouch configuration
[bltouch]
control_pin: bltouch_control_pin
sensor_pin: ^bltouch_sensor_pin
x_offset: -28
y_offset: -27
#z_offset: 3.1

[fan]
pin: !fan_part_cooling_pin
shutdown_speed: 1.0


[output_pin 4028_POWER]
pin: PB11
value: 1
shutdown_value: 0 # turn the fan power off on MCU shutdown.

[heater_fan]
pin: PD13
shutdown_speed: 1.0

#[heater_fan toolhead_cooling_fan]
#heater: extruder
#fan_speed: 1
#pin: !PD13


#[heater_fan toolhead_cooling_fan]
#pin: fan_toolhead_cooling_pin
#fan_speed: 1
#heater: extruder

[controller_fan controller_fan]
pin: fan_controller_board_pin
heater: extruder

[gcode_arcs]
resolution: 1.0

[filament_switch_sensor my_sensor]
pause_on_runout: True
runout_gcode:
    PARK_MACRO
    M117 Out of Filament
insert_gcode:
    M117 Filament Insert
    RESUME_MACRO
event_delay: 3.0
pause_delay: 0.5
switch_pin: PC0

[gcode_macro LOAD_FILAMENT]
description: Loads new filament. Note: be careful with PETG, make sure you inspect the tip of your filament before loading to avoid jams.
variable_ignore_min_extrude_temp: True                # needed for fluidd
gcode:
	_LEARN_MORE_FILAMENT
	
	# parameter
	{% set temp = params.TEMP|default(250)|int %}
	{% set toolhead = params.TOOLHEAD|default(-1)|int %}
	{% set filament_name = params._NAME|default('')|string %}
	{% set filament_type = params._TYPE|default('')|string %}
	{% if filament_name == '' or filament_type == '' %}
		{% set filament_name = 'unknown' %}
		{% set filament_type = 'unknown' %}
	{% endif %}

	{% if printer["dual_carriage"] is not defined %}
		_DEFAULT_LOAD_FILAMENT TEMP={temp} NAME={filament_name} TYPE={filament_type}
	{% else %}
		{% if not printer.pause_resume.is_paused %}
			{% set toolhead = params.TOOLHEAD|default(-1)|int %}
		{% else %}
			{% set current_idex_mode = printer["dual_carriage"].carriage_1|lower %}
			{% if current_idex_mode == 'copy' or current_idex_mode == 'mirror' %}
				{action_raise_error("Loading filament in Copy or Mirror mode is not supported! Select single mode to proceed.")}
			{% else %}
				{% set paused_idex_mode = printer["gcode_macro PAUSE"].idex_mode|lower %}
				{% if paused_idex_mode == 'copy' or paused_idex_mode == 'mirror' %}
					{% set toolhead = params.TOOLHEAD|default(-1)|int %}
				{% else %}
					{% set toolhead = printer["gcode_macro PAUSE"].idex_toolhead|int %}
				{% endif %}
			{% endif %}
		{% endif %}
		{% if toolhead==0 or toolhead==1 %}
			_IDEX_LOAD_FILAMENT TEMP={temp} TOOLHEAD={toolhead} NAME={filament_name} TYPE={filament_type}
		{% else %}
			RATOS_ECHO MSG="Please select toolhead! 0 = left, 1 = right toolhead"
		{% endif %}
	{% endif %}

[include moonraker_obico_macros.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 68.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 41.8
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	0.003125, -0.026563, -0.112188
#*# 	0.053750, -0.015625, -0.108438
#*# 	0.005625, -0.024688, -0.130313
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 134.958
#*# max_x = 265.038
#*# min_y = 149.458
#*# max_y = 250.53799999999998
#*#
#*# [bltouch]
#*# z_offset = 2.810
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 10.810
#*# pid_ki = 1.501
#*# pid_kd = 19.459

